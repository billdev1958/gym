<!DOCTYPE html>
<html th:replace="~{layouts/main :: layout(~{::title}, ~{::content})}">

<th:block th:fragment="title">Editar Membresía</th:block>

<div th:fragment="content">
    <div class="auth-container" style="max-width: 700px; text-align: left;">

        <div style="margin-bottom: 30px; text-align: center;">
            <h1>Editar Membresía</h1>
            <p style="color: #86868b;">Modificar precios y aplicar promociones.</p>
        </div>

        <form th:action="@{/memberships/save}" th:object="${membership}" method="post">

            <input type="hidden" th:field="*{id}" />
            <input type="hidden" th:field="*{createdAt}" />

            <h3
                style="font-size: 14px; text-transform: uppercase; color: #86868b; border-bottom: 1px solid #d2d2d7; padding-bottom: 10px; margin-bottom: 20px;">
                Detalles del Plan</h3>

            <div class="form-group">
                <label class="form-label">Nombre</label>
                <input type="text" th:field="*{name}" class="form-input" required>
            </div>

            <div class="form-group">
                <label class="form-label">Duración (Días)</label>
                <input type="number" th:field="*{durationDays}" class="form-input" required>
            </div>

            <h3
                style="font-size: 14px; text-transform: uppercase; color: #86868b; border-bottom: 1px solid #d2d2d7; padding-bottom: 10px; margin-bottom: 20px; margin-top: 30px;">
                Costos y Promociones</h3>

            <div
                style="background-color: #f5f5f7; padding: 20px; border-radius: 12px; border: 1px solid #d2d2d7; margin-bottom: 20px;">

                <div class="form-group">
                    <label class="form-label">Aplicar Descuento (%)</label>
                    <select id="discountSelect" class="form-input" style="background-color: white;"
                        onchange="window.applyDiscount()">
                        <option value="0">Sin descuento (Precio Original)</option>
                        <option value="5">5%</option>
                        <option value="10">10%</option>
                        <option value="15">15%</option>
                        <option value="20">20%</option>
                        <option value="25">25%</option>
                        <option value="30">30%</option>
                        <option value="40">40%</option>
                        <option value="50">50%</option>
                        <option value="70">70%</option>
                    </select>
                    <p style="font-size: 11px; color: #86868b; margin-top: 5px;">Al seleccionar, se actualizará el costo
                        y la descripción automáticamente.</p>
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Costo Final</label>
                    <input type="number" id="costInput" th:field="*{cost}" step="0.01" class="form-input"
                        style="font-weight: 700; color: #1d1d1f;" required>

                    <input type="hidden" id="baseCost" th:value="*{cost}">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Descripción</label>
                <textarea id="descInput" th:field="*{description}" class="form-input"
                    style="height: 100px; padding-top: 10px; line-height: 1.5;" required></textarea>
            </div>

            <div style="margin-top: 2rem; display: flex; gap: 15px;">
                <button type="submit" class="btn-apple">Guardar Cambios</button>
                <a href="/memberships" class="btn-apple"
                    style="background-color: #f5f5f7; color: #1d1d1f; text-decoration: none; text-align: center; line-height: 50px;">Cancelar</a>
            </div>

        </form>
    </div>

    <script th:inline="javascript">
        window.applyDiscount = function () {
            const select = document.getElementById('discountSelect');
            const costInput = document.getElementById('costInput');
            const baseCostInput = document.getElementById('baseCost');
            const descInput = document.getElementById('descInput');

            if (!select || !costInput || !baseCostInput || !descInput) return;

            const discountPercent = parseFloat(select.value);
            const baseCost = parseFloat(baseCostInput.value);
            let currentDesc = descInput.value;

            const newCost = baseCost - (baseCost * (discountPercent / 100));
            costInput.value = newCost.toFixed(2);

            const discountText = ` + descuento del ${discountPercent}%`;

            const regex = /(\s+)?\+\s+descuento\s+del\s+\d+%/gi;
            if (discountPercent > 0) {
                if (regex.test(currentDesc)) {
                    currentDesc = currentDesc.replace(regex, discountText);
                } else {
                    currentDesc = currentDesc.trim() + discountText;
                }
            } else {
                currentDesc = currentDesc.replace(regex, '').trim();
                costInput.value = baseCost.toFixed(2);
            }

            descInput.value = currentDesc;
        };
    </script>
</div>

</html>